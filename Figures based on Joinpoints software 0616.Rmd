---
title: "joinpoint"
output: pdf_document
date: "2025-03-21"
---

```{r}
library(dplyr)
library(data.table)
library(survey)
library(gtsummary)
library(gt)
library(ggplot2)
library(srvyr)
library(patchwork)
library(officer)
library(doParallel)
library(foreach)
library(haven)
library(tidyr)
```

#Figure 1: Secular trends in diabetes prevalence in the United States.
fig.1a
```{r}
svy_design_full <- svydesign(
  ids = ~SDMVPSU,    
  strata = ~SDMVSTRA,  
  weights = ~weight.fasting,  
  data = all3,  
  nest = TRUE
)

srvyr_design_full <- as_survey_design(svy_design_full)
#calculate whole cohort
prevalence_data_fig1_whole <- srvyr_design_full %>%
  group_by(cycle_label) %>%
  summarize(
    DM_all = survey_mean(DM.all, vartype = "ci", proportion = TRUE) * 100, # add confidence interval
    DM_doc = survey_mean(DM.doc, vartype = "ci", proportion = TRUE) * 100,
    DM_undx = survey_mean(DM.undx, vartype = "ci", proportion = TRUE) * 100
  ) %>%
  ungroup()
```


```{r}
cycle_mapping <- data.frame(
  cycle_label_numeric = 1:10,  
  cycle_label = c("2001-2002", "2003-2004", "2005-2006", "2007-2008",
                  "2009-2010", "2011-2012", "2013-2014", "2015-2016",
                  "2017-2020", "2021-2023")  
)

# DM doc
segment_data <- data.frame(
  cycle_label_start = c(1, 4, 6, 9),  
  cycle_label_end = c(4, 6, 9,10),  
  intercept = c(-2.816756, -2.563238, -2.950329, -1.677425),  
  slope = c(0.085558, 0.022178, 0.086693, -0.05474)  
)
segment_data_doc <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)


# DM all
segment_data_all <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.25,  
  slope = 0.041 
)
segment_data_all <- segment_data_all %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

# DM undx
segment_data_undx <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -3.138533,  
  slope = -0.000432 
)
segment_data_undx <- segment_data_undx %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

# 
fig_1a = ggplot(prevalence_data_fig1_whole, aes(x = cycle_label)) +
  # confidence interval
  geom_ribbon(aes(ymin = DM_all_low, ymax = DM_all_upp, fill = "Any diabetes", group = "Any diabetes"), alpha = 0.2) +
  geom_ribbon(aes(ymin = DM_doc_low, ymax = DM_doc_upp, fill = "diagnosed diabetes", group = "diagnosed diabetes"), alpha = 0.2) +
  geom_ribbon(aes(ymin = DM_undx_low, ymax = DM_undx_upp, fill = "undiagnosed diabetes", group = "undiagnosed diabetes"), alpha = 0.2) +

  geom_segment(data = segment_data_doc, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "diagnosed diabetes"), size = 0.8) +
  geom_segment(data = segment_data_all, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "Any diabetes"), size = 0.8) +
  geom_segment(data = segment_data_undx, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "undiagnosed diabetes"), size = 0.8) +

  geom_point(aes(y = DM_all, color = "Any diabetes"), size = 2) +
  geom_text(aes(y = DM_all, label = sprintf("%.1f%%", DM_all)), vjust = -0.5, size = 3) +
  geom_point(aes(y = DM_doc, color = "diagnosed diabetes"), size = 2) +
  geom_text(aes(y = DM_doc, label = sprintf("%.1f%%", DM_doc)), vjust = -0.5, size = 3) +
  geom_point(aes(y = DM_undx, color = "undiagnosed diabetes"), size = 2) +
  geom_text(aes(y = DM_undx, label = sprintf("%.1f%%", DM_undx)), vjust = -0.5, size = 3) +

  # p values annotated
  annotate("text", x = 10.5, y = prevalence_data_fig1_whole$DM_all[nrow(prevalence_data_fig1_whole)] , 
           label = "p < 0.0001", color = "black", size = 3, hjust = 0) +
  annotate("text", x = 10.5, y = prevalence_data_fig1_whole$DM_doc[nrow(prevalence_data_fig1_whole)] , 
           label = "p < 0.0001", color = "black", size = 3, hjust = 0) +
  annotate("text", x = 10.5, y = prevalence_data_fig1_whole$DM_undx[nrow(prevalence_data_fig1_whole)] , 
           label = "p = 0.91", color = "black", size = 3, hjust = 0) +

  
  labs(title = "Figure 1A: Secular Trends in Diabetes Prevalence (All)",
       x = "Cycle", y = "Prevalence",
       color = "", fill = "") +
  scale_color_manual(values = c("Any diabetes" = "goldenrod1", 
                                "diagnosed diabetes" = "olivedrab3", 
                                "undiagnosed diabetes" = "skyblue")) +  
  scale_fill_manual(values = c("Any diabetes" = "goldenrod1", 
                               "diagnosed diabetes" = "olivedrab3", 
                               "undiagnosed diabetes" = "skyblue")) +
  coord_cartesian(ylim = c(0, 22), clip = "off")  +
  scale_x_discrete(expand = expansion(mult = c(0.05, 0.1))) +  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5, size = 14),
        plot.margin = margin(10, 30, 10, 10))

print(fig_1a)



```



```{r}
options(survey.lonely.psu = "adjust")
generate_plot_fig1 <- function(data, filter_conditions, weight_var, title, p_value_all_label, p_value_doc_label, p_value_undx_label) {
  
  filtered_data <- data %>% filter(!!!filter_conditions)
  
  #survey design
  svy_design <- svydesign(
    ids = ~SDMVPSU,
    strata = ~SDMVSTRA, 
    weights = as.formula(paste0("~", weight_var)),
    data = filtered_data,
    nest = TRUE
  )
  
  srvyr_design <- as_survey_design(svy_design)
  
  # Calculate prevalence
  prevalence_data <- srvyr_design %>%
    group_by(cycle_label) %>%
    summarize(
      DM_all = survey_mean(DM.all, vartype = "ci", proportion = TRUE) * 100,
      DM_doc = survey_mean(DM.doc, vartype = "ci", proportion = TRUE) * 100,
      DM_undx = survey_mean(DM.undx, vartype = "ci", proportion = TRUE) * 100
    ) %>%
    ungroup()
  
  
  # Plot
p <-   ggplot(prevalence_data, aes(x = cycle_label)) +
    geom_ribbon(aes(
      ymin = DM_all_low, ymax = DM_all_upp, fill = "Any diabetes", group = "Any diabetes"
    ), alpha = 0.2) +
    geom_ribbon(aes(
      ymin = DM_doc_low, ymax = DM_doc_upp, fill = "diagnosed diabetes", group = "diagnosed diabetes"
    ), alpha = 0.2) +
    geom_ribbon(aes(
      ymin = DM_undx_low, ymax = DM_undx_upp, fill = "undiagnosed diabetes", group = "undiagnosed diabetes"
    ), alpha = 0.2) +
    geom_point(aes(y = DM_all, color = "Any diabetes"), size = 2) +
    geom_text(aes(y = DM_all, label = sprintf("%.1f%%", DM_all)), vjust = -0.5, size = 3) +
    geom_point(aes(y = DM_doc, color = "diagnosed diabetes"), size = 2) +
    geom_text(aes(y = DM_doc, label = sprintf("%.1f%%", DM_doc)), vjust = -0.5, size = 3) +
    geom_point(aes(y = DM_undx, color = "undiagnosed diabetes"), size = 2) +
    geom_text(aes(y = DM_undx, label = sprintf("%.1f%%", DM_undx)), vjust = -0.5, size = 3) +
    annotate("text", x = 10.5, y = prevalence_data$DM_all[nrow(prevalence_data)] ,
             label = p_value_all_label, color = "black", size = 3, hjust = 0) +
    annotate("text", x = 10.5, y = prevalence_data$DM_doc[nrow(prevalence_data)] ,
             label = p_value_doc_label, color = "black", size = 3, hjust = 0) +
    annotate("text", x = 10.5, y = prevalence_data$DM_undx[nrow(prevalence_data)] ,
             label = p_value_undx_label, color = "black", size = 3, hjust = 0) +
    labs(
      title = title,
      x = "Cycle",
      y = "Prevalence",
      color = "",
      fill = ""
    ) +
    scale_color_manual(values = c(
      "Any diabetes" = "goldenrod1",
      "diagnosed diabetes" = "olivedrab3",
      "undiagnosed diabetes" = "skyblue"
    )) +
    scale_fill_manual(values = c(
      "Any diabetes" = "goldenrod1",
      "diagnosed diabetes" = "olivedrab3",
      "undiagnosed diabetes" = "skyblue"
    )) +
    coord_cartesian(ylim = c(0, 30), clip = "off") +
    scale_x_discrete(expand = expansion(mult = c(0.05, 0.1))) +
    theme_minimal() +
    theme(
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(30, 0, 10, 50)
    )
return(p)
}
```


```{r}
#fig 1b
fig_1b = generate_plot_fig1(all3, filter_conditions <- list(quote(sex == "Male")), "weight.fasting", "Figure 1B: Secular Trends in Diabetes Prevalence (Men)","p < 0.0001", "p < 0.0001", "p = 0.29")


cycle_mapping <- data.frame(
  cycle_label_numeric = 1:10,  
  cycle_label = c("2001-2002", "2003-2004", "2005-2006", "2007-2008",
                  "2009-2010", "2011-2012", "2013-2014", "2015-2016",
                  "2017-2020", "2021-2023")  
)

# DM doc
segment_data <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.780825,  
  slope = 0.073468
)
segment_data_doc <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)


# DM all
segment_data_all <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.156017,  
  slope = 0.042215 
)
segment_data_all <- segment_data_all %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

# DM undx
segment_data_undx <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.858086,  
  slope = -0.01899 
)
segment_data_undx <- segment_data_undx %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig_1b <- fig_1b +   geom_segment(data = segment_data_doc, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "diagnosed diabetes"), size = 0.8) +
  geom_segment(data = segment_data_all, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "Any diabetes"), size = 0.8) +
  geom_segment(data = segment_data_undx, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "undiagnosed diabetes"), size = 0.8) 
  
print(fig_1b) 
```

```{r}
#fig 1c
fig_1c = generate_plot_fig1(all3, filter_conditions <- list(quote(sex == "Female")), "weight.fasting", "Figure 1C: Secular Trends in Diabetes Prevalence (Women)", "p = 0.0004", "p < 0.0001", "p < 0.0001")


cycle_mapping <- data.frame(
  cycle_label_numeric = 1:10,  
  cycle_label = c("2001-2002", "2003-2004", "2005-2006", "2007-2008",
                  "2009-2010", "2011-2012", "2013-2014", "2015-2016",
                  "2017-2020", "2021-2023")  
)

# DM doc
segment_data <- data.frame(
  cycle_label_start = c(1,3, 5, 7),  
  cycle_label_end = c(3,5, 7, 10),  
  intercept = c(-3.089548, -2.216918, -3.03251, -2.34434),  
  slope = c(0.22466,-0.066217, 0.096902, -0.001408 )
)
segment_data_doc <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)


# DM all
segment_data_all <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.348928,  
  slope = 0.039208 
)
segment_data_all <- segment_data_all %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

# DM undx
segment_data_undx <- data.frame(
  cycle_label_start = c(1, 2, 4, 7, 9),  
  cycle_label_end = c(2, 4, 7, 9, 10),  
  intercept = c(-2.841784, -3.940816, -3.28985, -4.838008, -0.85063),  
  slope = c(-0.408477, 0.141039, -0.021703, 0.199463, -0.243579) 
)
segment_data_undx <- segment_data_undx %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig_1c <- fig_1c +   geom_segment(data = segment_data_doc, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "diagnosed diabetes"), size = 0.8) +
  geom_segment(data = segment_data_all, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "Any diabetes"), size = 0.8) +
  geom_segment(data = segment_data_undx, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "undiagnosed diabetes"), size = 0.8) 
  
print(fig_1c) 
```

```{r}
#fig 1d
fig_1d = generate_plot_fig1(all3, filter_conditions <- list(quote(ridreth3 == "Mexican American" | ridreth3 == "Other Hispanic")), "weight.fasting", "Figure 1D: Secular Trends in Diabetes Prevalence (Hispanic/Latino)","p = 0.0052", "p = 0.018", "p = 0.62")

# DM doc
segment_data <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.651631,  
  slope = 0.057193
)
segment_data_doc <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)


# DM all
segment_data_all <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.134017,  
  slope = 0.039121 
)
segment_data_all <- segment_data_all %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

# DM undx
segment_data_undx <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -3.076859,  
  slope = 0.013432 
)
segment_data_undx <- segment_data_undx %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig_1d <- fig_1d +   geom_segment(data = segment_data_doc, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "diagnosed diabetes"), size = 0.8) +
  geom_segment(data = segment_data_all, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "Any diabetes"), size = 0.8) +
  geom_segment(data = segment_data_undx, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "undiagnosed diabetes"), size = 0.8) 
  
print(fig_1d) 
```

```{r}
#fig 1e
fig_1e = generate_plot_fig1(all3, filter_conditions <- list(quote(ridreth3 == "Non-Hispanic Black")), "weight.fasting", "Figure 1E: Secular Trends in Diabetes Prevalence (Non-Hispanic Black)", "p = 0.038", "p = 0.072", "p = 0.58")

# DM doc
segment_data <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.328901,  
  slope = 0.035262
)
segment_data_doc <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)


# DM all
segment_data_all <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -1.969994,  
  slope = 0.033274 
)
segment_data_all <- segment_data_all %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

# DM undx
segment_data_undx <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -3.137406,  
  slope = 0.02699
)
segment_data_undx <- segment_data_undx %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig_1e <- fig_1e +   geom_segment(data = segment_data_doc, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "diagnosed diabetes"), size = 0.8) +
  geom_segment(data = segment_data_all, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "Any diabetes"), size = 0.8) +
  geom_segment(data = segment_data_undx, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "undiagnosed diabetes"), size = 0.8) 
  
print(fig_1e) 
```

```{r}
#fig 1f
fig_1f = generate_plot_fig1(all3, filter_conditions <- list(quote(ridreth3 == "Non-Hispanic White")), "weight.fasting", "Figure 1F: Secular Trends in Diabetes Prevalence (Non-Hispanic White)", "p < 0.0001", "p = 0.011", "p = 0.35")

# DM doc
segment_data <- data.frame(
  cycle_label_start = c(1,8),  
  cycle_label_end = c(8,10),  
  intercept = c(-2.967346, -2.194438),  
  slope = c(0.083782, -0.012832)
)
segment_data_doc <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)


# DM all
segment_data_all <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -2.363815,  
  slope = 0.045106 
)
segment_data_all <- segment_data_all %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

# DM undx
segment_data_undx <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -3.146946,  
  slope = -0.011196
)
segment_data_undx <- segment_data_undx %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig_1f <- fig_1f +   geom_segment(data = segment_data_doc, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "diagnosed diabetes"), size = 0.8) +
  geom_segment(data = segment_data_all, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "Any diabetes"), size = 0.8) +
  geom_segment(data = segment_data_undx, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "undiagnosed diabetes"), size = 0.8) 
  
print(fig_1f) 
```
```{r}
figure_1 <- (fig_1a / fig_1b / fig_1c) | (fig_1d / fig_1e / fig_1f)
print(figure_1)
ggsave(
  filename = "Figure_1.pdf",
  plot = figure_1,
  width = 23,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
```


```{r}
ggsave(
  filename = "Figure_1a.pdf",
  plot = fig_1a,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "Figure_1b.pdf",
  plot = fig_1b,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "Figure_1c.pdf",
  plot = fig_1c,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "Figure_1d.pdf",
  plot = fig_1d,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "Figure_1e.pdf",
  plot = fig_1e,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "Figure_1f.pdf",
  plot = fig_1f,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
```


```{r}
#fig 1c
fig_1c = generate_plot_fig1(all3, filter_conditions <- list(quote(sex == "Female")), "weight.fasting", "Figure 1C: Secular Trends in Diabetes Prevalence (Women)")
#fig 1d
fig_1d = generate_plot_fig1(all3, filter_conditions <- list(quote(ridreth3 == "Mexican American" | ridreth3 == "Other Hispanic")), "weight.fasting", "Figure 1D: Secular Trends in Diabetes Prevalence (Hispanic/Latino)")
#fig 1e
fig_1e = generate_plot_fig1(all3, filter_conditions <- list(quote(ridreth3 == "Non-Hispanic Black")), "weight.fasting", "Figure 1E: Secular Trends in Diabetes Prevalence (Non-Hispanic Black)")
#fig 1f
fig_1f = generate_plot_fig1(all3, filter_conditions <- list(quote(ridreth3 == "Non-Hispanic White")), "weight.fasting", "Figure 1F: Secular Trends in Diabetes Prevalence (Non-Hispanic White)")
```


#Figure 2: Secular trends in glycemic control among United States adults with diagnosed diabetes. (A1c < 7%)
```{r}
#figure 2
all3[,HBA1C_cate7:=fifelse(HBA1C<7, 1, 0)]
generate_plot_fig2 <- function(data, filter_conditions, weight_var, plot_title, p_value) {
  
  filtered_data <- data %>% filter(!!!filter_conditions)
  
  # Create survey design
  svy_design <- svydesign(
    ids = ~SDMVPSU,
    strata = ~SDMVSTRA, 
    weights = as.formula(paste0("~", weight_var)),
    data = filtered_data,
    nest = TRUE
  )
  
  srvyr_design <- as_survey_design(svy_design)
  
  # Calculate prevalence
  prevalence_data <- srvyr_design %>%
    group_by(cycle_label) %>%
    summarize(
      HBA1C1 = survey_mean(HBA1C_cate7, vartype = "ci", proportion = TRUE) * 100
    ) %>%
    ungroup()
  
  # Fit weighted linear regression
  trend_test_all <- svyglm(HBA1C_cate7 ~ cycle_label_numeric, design = svy_design, family = binomial())
  

  
  # Plot
  p <- ggplot(prevalence_data, aes(x = cycle_label)) +
    geom_ribbon(aes(
      ymin = HBA1C1_low, ymax = HBA1C1_upp, fill = "% with HBA1C < 7", group = "% with HBA1C < 7"
    ), alpha = 0.2) +
    geom_point(aes(y = HBA1C1, color = "% with HBA1C < 7"), size = 2) +
    geom_text(aes(y = HBA1C1, label = sprintf("%.1f%%", HBA1C1)), vjust = -0.5, size = 3) +
    annotate("text", x = 10.2, y = prevalence_data$HBA1C1[nrow(prevalence_data)],
             label = p_value, color = "black", size = 3, hjust = 0) +
    
    labs(
      title = plot_title,
      x = "Cycle",
      y = "Prevalence of adequate glycemic control (HBA1c < 7%)",
      color = "",
      fill = ""
    ) +
    scale_color_manual(values = c(
      "% with HBA1C < 7" = "goldenrod1"
    )) +
    scale_fill_manual(values = c(
      "% with HBA1C < 7" = "goldenrod1"
    )) +
    coord_cartesian(ylim = c(0, 90), clip = "off") +
    scale_x_discrete(expand = expansion(mult = c(0.05, 0.1))) +
    theme_minimal() +
    theme(
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(30, 0, 10, 50),
      legend.position = "none"
    )
  return(p)
}
```


```{r}
fig2a = generate_plot_fig2(all3, filter_conditions <- list(quote(DM.doc==1)), "weight.fasting", "Figure 2A: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (All)", "p = 0.0012")

segment_data <- data.frame(
  cycle_label_start = c(1,2,7,9),  
  cycle_label_end = c(2,7,9,10),  
  intercept = c(-0.376954,-0.543995, -0.912246, 0.490295),  
  slope = c(-0.109749, -0.025779, 0.026828, -0.129010)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig2a <- fig2a +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 7"), size = 0.8)
print(fig2a)
```


```{r}
options(survey.lonely.psu = "adjust")
fig2b = generate_plot_fig2(all3, filter_conditions <- list(quote(DM.doc==1 & sex == "Male")), "weight.fasting", "Figure 2B: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Men)", "p < 0.0001")

segment_data <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -0.540382,  
  slope = -0.031354
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig2b <- fig2b +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 7"), size = 0.8)
print(fig2b)
```


```{r}
fig2c = generate_plot_fig2(all3, filter_conditions <- list(quote(DM.doc==1 & sex == "Female")), "weight.fasting", "Figure 2C: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Women)", "p = 0.12")


segment_data <- data.frame(
  cycle_label_start = c(1, 6),  
  cycle_label_end = c(6,10),  
  intercept = c(-0.403158, -0.773193),  
  slope = c(-0.045264, 0.016408)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig2c <- fig2c +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 7"), size = 0.8)
print(fig2c)
```


```{r}
fig2d = generate_plot_fig2(all3, filter_conditions <- list(quote(DM.doc==1 & (ridreth3 == "Mexican American" | ridreth3 == "Other Hispanic"))), "weight.fasting", "Figure 2D: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Hispanic/Latino)", "p < 0.0001")

segment_data <- data.frame(
  cycle_label_start = c(1, 2, 4, 6, 9),  
  cycle_label_end = c(2, 4, 6, 9, 10),  
  intercept = c(-0.261879, -1.497516, -0.361092, -1.294329, 1.423631),  
  slope = c(-0.428517, 0.189302, -0.094804, 0.060735, -0.241260)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig2d <- fig2d +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 7"), size = 0.8)
print(fig2d)

```


```{r}
fig2e = generate_plot_fig2(all3, filter_conditions <- list(quote(DM.doc==1 & ridreth3 =="Non-Hispanic Black")), "weight.fasting", "Figure 2E: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Non-Hispanic Black)", "p = 0.0004")

segment_data <- data.frame(
  cycle_label_start = c(1, 6),  
  cycle_label_end = c(6, 10),  
  intercept = c(-0.868120, -0.142086),  
  slope = c(0.043556, -0.077450)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig2e <- fig2e +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 7"), size = 0.8)
print(fig2e)
```


```{r}
fig2f = generate_plot_fig2(all3, filter_conditions <- list(quote(DM.doc==1 & ridreth3 == "Non-Hispanic White")), "weight.fasting", "Figure 2F: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Non-Hispanic White)", "p < 0.0001")

segment_data <- data.frame(
  cycle_label_start = c(1,3,5, 7),  
  cycle_label_end = c(3,5,7, 10),  
  intercept = c(-0.242605, -0.531904, -0.272519, -0.937825),  
  slope = c(-0.108413, -0.011980, -0.063857, 0.031186)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

fig2f <- fig2f +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 7"), size = 0.8)
print(fig2f)
```

```{r}
figure_2 <- (fig2a / fig2b / fig2c) | (fig2d / fig2e / fig2f)
print(figure_2)
ggsave(
  filename = "figure_2.pdf",
  plot = figure_2,
  width = 23,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
```

```{r}
ggsave(
  filename = "fig2a.pdf",
  plot = fig2a,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "fig2b.pdf",
  plot = fig2b,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "fig2c.pdf",
  plot = fig2c,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "fig2d.pdf",
  plot = fig2d,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "fig2e.pdf",
  plot = fig2e,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "fig2f.pdf",
  plot = fig2f,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
```



#Supp. Figure 2: Secular trends in glycemic control among adults with diagnosed diabetes.(A1c < 8%) 
```{r}
#figure 2
all3[,HBA1C_cate8:=fifelse(HBA1C<8, 1, 0)]
generate_plot_suppfig2 <- function(data, filter_conditions, weight_var, plot_title, p_value) {
  
  filtered_data <- data %>% filter(!!!filter_conditions)
  
  # Create survey design
  svy_design <- svydesign(
    ids = ~SDMVPSU,
    strata = ~SDMVSTRA, 
    weights = as.formula(paste0("~", weight_var)),
    data = filtered_data,
    nest = TRUE
  )
  
  srvyr_design <- as_survey_design(svy_design)
  
  # Calculate prevalence
  prevalence_data <- srvyr_design %>%
    group_by(cycle_label) %>%
    summarize(
      HBA1C1 = survey_mean(HBA1C_cate8, vartype = "ci", proportion = TRUE) * 100
    ) %>%
    ungroup()
  
  # Plot
  p <- ggplot(prevalence_data, aes(x = cycle_label)) +
    geom_ribbon(aes(
      ymin = HBA1C1_low, ymax = HBA1C1_upp, fill = "% with HBA1C < 8", group = "% with HBA1C < 8"
    ), alpha = 0.2) +
    geom_point(aes(y = HBA1C1, color = "% with HBA1C < 8"), size = 2) +
    geom_text(aes(y = HBA1C1, label = sprintf("%.1f%%", HBA1C1)), vjust = -0.5, size = 3) +
    annotate("text", x = 10.2, y = prevalence_data$HBA1C1[nrow(prevalence_data)],
             label = p_value, color = "black", size = 3, hjust = 0) +
    
    labs(
      title = plot_title,
      x = "Cycle",
      y = "Prevalence of adequate glycemic control (HBA1c < 8%)",
      color = "",
      fill = ""
    ) +
    scale_color_manual(values = c(
      "% with HBA1C < 8" = "goldenrod1"
    )) +
    scale_fill_manual(values = c(
      "% with HBA1C < 8" = "goldenrod1"
    )) +
    coord_cartesian(ylim = c(0, 90), clip = "off") +
    scale_x_discrete(expand = expansion(mult = c(0.05, 0.1))) +
    theme_minimal() +
    theme(
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(30, 0, 10, 50),
      legend.position = "none"
    )
  return(p)
}
```


```{r}
supp.fig2a = generate_plot_suppfig2(all3, filter_conditions <- list(quote(DM.doc==1)), "weight.fasting", "Supp.Figure 2A: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (All)", "p = 0.050")

segment_data <- data.frame(
  cycle_label_start = c(1,7,9),  
  cycle_label_end = c(7,9,10),  
  intercept = c(-0.171502, -0.866891, 1.087319),  
  slope = c(-0.030864, 0.068477, -0.148657)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

supp.fig2a <- supp.fig2a +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 8"), size = 0.8)
print(supp.fig2a)
```


```{r}
supp.fig2b = generate_plot_suppfig2(all3, filter_conditions <- list(quote(DM.doc==1 & sex == "Male")), "weight.fasting", "Supp.Figure 2B: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Men)", "p = 0.0024")

segment_data <- data.frame(
  cycle_label_start =c(1,7,9),  
  cycle_label_end = c(7,9,10),  
  intercept = c(-0.168303, -0.991918, 1.587434),  
  slope = c(-0.035884, 0.081775, -0.204820)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

supp.fig2b <- supp.fig2b +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 8"), size = 0.8)
print(supp.fig2b)
```


```{r}
supp.fig2c = generate_plot_suppfig2(all3, filter_conditions <- list(quote(DM.doc==1 & sex == "Female")), "weight.fasting", "Supp.Figure 2C: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Women)", "p = 0.44")


segment_data <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -0.198808,  
  slope = -0.010446
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

supp.fig2c <- supp.fig2c +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 8"), size = 0.8)
print(supp.fig2c)
```


```{r}
supp.fig2d = generate_plot_suppfig2(all3, filter_conditions <- list(quote(DM.doc==1 & (ridreth3 == "Mexican American" | ridreth3 == "Other Hispanic"))), "weight.fasting", "Supp.Figure 2D: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Hispanic/Latino)", "p < 0.0001")

segment_data <- data.frame(
  cycle_label_start = c(1,2,5,7,9),  
  cycle_label_end = c(2,5,7,9,10),  
  intercept = c(-0.004900, -0.601490, 0.048042, -1.227436, 1.049003),  
  slope = c(-0.256062, 0.0242233, -0.087673, 0.094538, -0.158400)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

supp.fig2d <- supp.fig2d +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 8"), size = 0.8)
print(supp.fig2d)

```


```{r}
supp.fig2e = generate_plot_suppfig2(all3, filter_conditions <- list(quote(DM.doc==1 & ridreth3 =="Non-Hispanic Black")), "weight.fasting", "Supp.Figure 2E: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Non-Hispanic Black)", "p = 0.46")

segment_data <- data.frame(
  cycle_label_start = 1,  
  cycle_label_end = 10,  
  intercept = -0.284494, 
  slope = -0.017468
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

supp.fig2e <- supp.fig2e +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 8"), size = 0.8)
print(supp.fig2e)
```


```{r}
supp.fig2f = generate_plot_suppfig2(all3, filter_conditions <- list(quote(DM.doc==1 & ridreth3 == "Non-Hispanic White")), "weight.fasting", "Supp.Figure 2F: Secular Trends in Diabetes Control in Individuals Diagnosed with Diabetes (Non-Hispanic White)", "p = 0.045")

segment_data <- data.frame(
  cycle_label_start = c(1, 6),  
  cycle_label_end = c(6, 10),  
  intercept = c(-0.056903, -0.479232),  
  slope = c(-0.047496, 0.022892)
)
segment_data <- segment_data %>%
  mutate(
    prev_start = 100 * exp(intercept + slope * cycle_label_start),  
    prev_end = 100 * exp(intercept + slope * cycle_label_end)  
  ) %>%
  left_join(cycle_mapping, by = c("cycle_label_start" = "cycle_label_numeric")) %>%
  rename(cycle_label_start_str = cycle_label) %>%
  left_join(cycle_mapping, by = c("cycle_label_end" = "cycle_label_numeric")) %>%
  rename(cycle_label_end_str = cycle_label)

supp.fig2f <- supp.fig2f +   geom_segment(data = segment_data, 
               aes(x = cycle_label_start_str, xend = cycle_label_end_str, 
                   y = prev_start, yend = prev_end, 
                   color = "% with HBA1C < 8"), size = 0.8)
print(supp.fig2f)
```

```{r}
supp.figure_2 <- (supp.fig2a / supp.fig2b / supp.fig2c) | (supp.fig2d / supp.fig2e / supp.fig2f)
print(supp.figure_2)
ggsave(
  filename = "supp.figure_2.pdf",
  plot = supp.figure_2,
  width = 23,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
```

```{r}
ggsave(
  filename = "supp.fig2a.pdf",
  plot = supp.fig2a,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "supp.fig2b.pdf",
  plot = supp.fig2b,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "supp.fig2c.pdf",
  plot = supp.fig2c,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "supp.fig2d.pdf",
  plot = supp.fig2d,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "supp.fig2e.pdf",
  plot = supp.fig2e,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
ggsave(
  filename = "supp.fig2f.pdf",
  plot = supp.fig2f,
  width = 15,    
  height = 15,   
  units = "in",  
  dpi = 300      
)
```

